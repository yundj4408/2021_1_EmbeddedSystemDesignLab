# 1. 임베디드 시스템 소개

### 1.1 Embedded System이란

**임베디드 시스템의 의미**

- 장치에 내장된 Process에 의해 특정한 목적의 기능을 수행하는 하드웨어와 소프트웨어가 조합된 정량화된 시스템.
- 임베디드 시스템은 특정 목적을 지닌 시스템이다. 반대로 PC는 특정 목적이 아닌 범용 목적을 갖는 시스템이다.
- PC는 프로그램 뿐만 아니라 그래픽 작업, 게임 등 범용의 기능을 제공하지만, 임베디드 시스템인 핸드폰은 통신 기능에 특화하여 개발되었고, 게임기도 게임기능에 특화하여 개발된 시스템이다.



**임베디드 시스템의 특징**

1. 기능이 제한적이다. 

   - 특정 기능에 특화된 시스템으로서 지정된 기능 외의 기능은 제공하지 않는다. 

2. 크기에 제약이 있다. 

   - 모바일 제품이 많기 때문에 크기가 작고 가벼워야 한다.

3. 저전력이여야 한다.

   - 배터리 용량의 한계로 전력 사용이 제한적이다.

4. 사용되는 프로세스나 운영체제가 다양하다.

   - 임베디드용으로 사용한다. PC 프로세서와 운영체제는 사용이 불가하다.

5. 실시간성을 제공해야 한다.

   - 의료기기, 공장 자동화 시스템, 군용에서는 한정된 시간 필수

6. 하드디스크(HDD)가 없다.

   - HDD대신 ROM, RAM, Flash 메모리로 구성되어 있다. 

   

### 1.2 Embedded System 구성

컴퓨터는 하드웨어 + 소프트웨어 + 펌웨어로 시스템이 구성된다. 

필자는 소프트웨어가 하드웨어의 반대말이라고 생각하였지만 그게 아니라 하드웨어, 소프트웨어 둘 다 컴퓨터 시스템을 구성하는 요소이기 때문에 상호 보완적 기능을 한다고 생각하면 된다. 반대말이 아니다. 

임베디드 시스템은 크게 **Hardware**와 **Software**로 나뉜다. 

![HWSWlayer](./Pictures/HWSWlayer.jpg)

1. **Hardware**

   - **Processor**

     - 정의 :  프로그램의 명령어를 처리하기 위한 장치를 말한다. 종류로는 MCU, MPU, CPU가 있다. 

     - **CPU(Central Processing Unit)**

       - 중앙 처리 장치(ALU + Register)는 컴퓨터 시스템을 통제하고 프로그램의 연산을 실행하고 처리하는 가장 핵심적인 컴퓨터의 제어 장치, 혹은 그 기능을 내장한 칩을 말한다. 
       - 제어장치, 연산장치, 레지스터 세부분으로 구성되어 있고, 주기억 장치를 비롯한 다른 장치들과 시스템 버스로 연결되어 있다. 
       - 제어장치(Control Unit) : 명령어를 해석하여 레지스터나 연산장치를 제어한다.
       - 연산장치(ALU) : 산술연산을 담당하며 제어장치의 제어를 받는다.
       - 레지스터(Register) : 소량의 데이터를 임시저장하는 공간이다. 
       - 밑에서 좀 더 자세하게 알아 볼 것이다. 

     - **MPU(Micro Processing Unit)**

       - CPU를 하나의 단일 IC(Integrated Circuit) 칩에 집적시켜 만든 반도체 소자를 MPU라고 한다. 산술 위주의 CPU라고 생각하면 된다. 
       - CPU의 여러 형태 중 소자가 하나인 종류가 MPU이며, 모든 MPU는 CPU이지만 모든 CPU가 MPU는 아니다. 
       - MPU는 MCU와 달리 ROM, RAM과 같은 저장장치, 입출력 포트 같은 출력장치 등의 주변 장치가 있어야 사용할 수 있다. 
       - MPU는 결국 저장장치, 출력장치와 함계 사용해야하는 연산 목적의 CPU

     - **MCU(Micro Controller Unit)**

       - MCU는 CPU 기능은 물론이고 일정한 용량의 메모리, 입출력 제어 인터페이스, 주변 장치 컨트롤러 회로까지 칩 하나에 내장한 반도체이다.
       - MCU는 PC의 메인보드 전체를 칩 하나에 집적시켜 놓은 것이라고 볼 수 있다. 그래서 기능이 많은 MCU의 경우, 칩에 전원을 연결하고 입출력 장치를 연결하기만 하면 그것 자체로 일종의 작은 컴퓨터가 되기도 한다. 
         ![MCU](/home/dongjun/mygit/2021_1_EmbeddedSystemDesignLab/Pictures/MCU.jpg)
       - MCU는 결국 저장장치와 출력장치가 내장된 단독 사용이 가능한 CPU

     - **DSP(Digital Signal Processing)**

       - DSP는 아날로그 신호를 A/D(아날로그/디지털)변환하여 얻어진 디지털 데이터에 대수적인 연산을 해 필터링이나 스펙트럼분석 등의 신호처리를 하는 것을 말한다. 기본적으로 아날로그 신호의 실시간 디지털 처리를 목적으로 한다. 
       - DSP는 디지털 신호를 수학적으로 빨리 계산할 수 있는 수학 연산 전문 반도체로 마이크로프로세서도 이러한 기능을 수행하지만 수학 연산만 전문으로 하는 DSP에 비해 속도가 느리다. 

       

   - **Memory 장치** 

     - ROM(NOR), RAM(DRAM, SRAM), Storage(NAND, SSD)
     - Temporary Memory(Volatile) : DRAM, SRAM
     - Permanent Memory(Nonvolatile) : ROM, NAND, Flash, EEPROM, SSD, HDD, CDROM

   - **I/O 장치** 

     - Network, LCD, GPIO

   

2. **Software**

   - **System Software:** Firmware(OS 개념이 없음), Device Driver(OS 관점)
   - **OS :** RTOS, Embedded OS
     - **RTOS(Real-Time OS)**
       - 주어진 임의의 작업에 대한 정해진 시간 내에 수행할 수 있도록 하는 환경을 제공
       - 개발시에 주로 운영체제와 Task들이 같이 빌드 된다. 
       - 예) 무인자동차를 운행하는 시스템에서 전방에 장애물이 나타났을 경우 반드시 부딪히기전에 멈춰서거나 피해가야 될 것이다. 어떤 상황(부딪히는 상황)에 대해서 정해진 시간(부딪히기 전)까지 반드시 응답을 주어야 하는 시스템에서 RTOS가 필요하게 된다.
     - **Embedded OS**
       - 여러 복잡한 작업들을 동시에 효율적으로 수행하기 위한 환경 제공
       - 이미 동작 중에 있는 운영체제 상에서 새로운 프로세스를 이식 할 수 있다.
       - Windows CE , Linux, Android, iOS
   - **Middleware :** Network Stack Protocol, File System
   - **Applications**



### 2.1 CPU 내부 동작

### ![CPUStructure](/home/dongjun/mygit/2021_1_EmbeddedSystemDesignLab/Pictures/CPUStructure.jpg)

1. **CPU (Central Processing Unit)**
   - CPU의 구성은 Processor Core + System Bus + Peripherals (HW IP) + Memory로 이루어 진다.
   - CPU안에 주변장치 (Peripherals), Memory 등을 모두 담고 있는 시스템을 SOC(System-On-Chip)라고 한다.  
2. **Processor Core** 
   - 몌모리 장치로부터 프로그램의 구성 요소인 fetch, decoding, execution하는 동작을 한다. 
   - 레지스터(Register), 연산장치(ALU), 제어장치(Control Unit), 버스(Bus), Cache memory(Optional), MMU(Optional) 등으로 구성된다.
   - Processor Core의 종류에는 ARM, MIPS, Intel의 Sandy Bridge 등도 Processor Core의 한 종류이다.
3. **Register**
   - 프로세서 코어에 위치하고 있고 프로세서가 접근 가능한 가장 빠른 임시 기억 장치로 ARM 프로세서는 3가지 종류의 레지스터가 있다.
   - General Purpose Register : 프로그램 데이터 처리에 사용된다.
   - Control Register : Stack Pointer, Link Register, Program Counter
     - Stack Pointer : 현재 프로세스 모드의 Stack의 Top 주소를 가르키고 있다.
     - Link Register : 서브루틴 분기시 서르부틴을 끝마치고 복귀 할 주소를 가지고 있다.
     - Program Count : 현재 실행 중인 주소 값이다.
     - Program Status Register : Processor 의 상태정보와 ALU의 결과 정보를 저장하고 있다.
       참고로 일반 레지스터 외에 특별한 레지스터가 있는데 주로 Processor 주위에 있는 주변 장치들을 제어하기 위해서 SFR (Special Function Register) 가 있다. 주로 Memory-Mapped 방식으로 접근이 되고 대부분 bit 단위로 제어가 된다.(AND, OR, EOR … ) 그리고 Memory-Mapped 되어 있다는 말은 SFR은 각 레지스터에 해당하는 주소가 정해져 있어 주소를 통해서 접근이 가능 하다는 이야기이다. S/W 엔지니어가 ARM 펌웨어 프로그램을 한다고 하면 대부분의 작업이 바로 SFR 레지스터를 세팅하고 제어하는 일이다.
4. **ALU (Arithmetic Logic Unit)**
   - 산술 연산 수행 : ADD, SUB 등 연산 수행
   - 논리 연산 수행 : AND, OR, XOR 등 연산 수행
   - Program Status Register Update  : Negative, Zero, Carry, Overflow, Saturation
5. **Control Unit**
   - 메모리에서 명령(Instruction)을 인출 한다.
   - 인출된 명령을 분석하여 어떤 명령인지 어떤 레지스터들이 사용되는지를 확인한다.
   - 명령어 실행에 필요한 제어 신호를 만들어 내고 실행한다. 
6. **Bus**
   - CPU와 메모리 사이의 데이터 통로
   - CPU : Bus Master
   - Memory  : Bus Slave
   - Bus는 Address, Control, Data 버스가 있다.
   - Bus
7. 



























![arm_memory_map-arm-cortex-m4-1](/home/dongjun/mygit/2021_1_EmbeddedSystemDesignLab/Pictures/arm_memory_map-arm-cortex-m4-1.gif)

내가 짠 코드는 메모리 0x00000000부터 들어가고 프로그램을 실행하기 위해 RAM에 Flash Memory 또는 ROM에 있던 코드를 올린다. 



![code-memory-cortex-m4-1](/home/dongjun/mygit/2021_1_EmbeddedSystemDesignLab/Pictures/code-memory-cortex-m4-1.png)





Vector table of ARM Cortex-M4

![VectorTableOfARMCORTEX_M4](/home/dongjun/mygit/2021_1_EmbeddedSystemDesignLab/Pictures/VectorTableOfARMCORTEX_M4.png)